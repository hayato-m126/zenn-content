---
title: "ros2 bag record ã§ sim_time ã‚’åæ˜ ã™ã‚‹"
emoji: "ğŸ™„"
type: "tech"
topics:
  - "ros2"
published: true
published_at: "2022-11-30 04:34"
---

## æ¦‚è¦

[ROS 2 humble ã®11æœˆã®ãƒªãƒªãƒ¼ã‚¹](https://discourse.ros.org/t/new-packages-and-patch-release-for-humble-hawksbill-2022-11-23/28495)ã§rosbag2ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå…¥ã‚Šã€recordæ™‚ã«sim_timeã‚’åæ˜ ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã®æ›´æ–°å†…å®¹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

### æƒ³å®šç’°å¢ƒ

- Ubuntu 22.04
- ROS 2 humble

### å¯¾è±¡èª­è€…

- ROS 2ã§é–‹ç™ºã—ã¦ã„ã‚‹æ–¹

### é–¢é€£ãƒªãƒ³ã‚¯

1. <https://github.com/ros2/rosbag2/issues/764>
2. <https://github.com/ros2/rosbag2/pull/994>

## å°å…¥æ–¹æ³•

apt ã§é…å¸ƒã•ã‚Œã¦ã„ã‚‹ã®ã§æ›´æ–°ã—ã¾ã™ã€‚

```shell
sudo apt update
sudo apt upgrade
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ`0.15.3-1`ç§»è¡Œã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚

```shell
â¯ apt-cache policy ros-humble-rosbag2
ros-humble-rosbag2:
  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 0.15.3-1jammy.20221109.192253
```

## ä½¿ã„æ–¹

sim_timeã§è¨˜éŒ²ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³`--use-sim-time`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚

```shell
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æµã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’ä½¿ã£ã¦è¨˜éŒ²ã™ã‚‹
ros2 bag record -a --use-sim-time
```

## ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã‚ˆã‚Šä½•ãŒå¤‰ã‚ã‚‹ã‹

æ¦‚è¦ã®é–¢é€£ãƒªãƒ³ã‚¯ã®1ã§ã‚‚è¿°ã¹ã‚‰ã‚Œã¦ã„ã‚‹é€šã‚Šã€ROS 2ã§ã¯å¾“æ¥ãƒ¬ã‚³ãƒ¼ãƒ‰ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ™‚é–“ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

å®Ÿæ©Ÿã§å–å¾—ã—ãŸbagã‚’ä½¿ã£ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«å‡ºåŠ›ã•ã‚Œã‚‹topicã‚’bagã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸæ™‚åˆ»ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯bag playã®rateã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€å€é€Ÿã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å›ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãã®çµæœã‚’å–ã£ãŸbagã®æ™‚é–“ã¾ã§ä¼¸ã³ç¸®ã¿ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ãªã®ã§ã€topicãŒæƒ³å®šé€šã‚Šã®å‘¨æœŸ[Hz]ã§è¨˜éŒ²ã•ã‚ŒãŸã‹èª¿ã¹ã‚‹ã¨ãç­‰ã«ã€ã©ã®rateã§å–ã£ãŸã‹ãŒã‚ã‹ã£ã¦ãªã„ã¨åˆ¤æ–­ã«å›°ã£ãŸã‚Šã—ã¾ã™ã€‚

```shell
# 2å€é€Ÿã§å†ç”Ÿ
ros2 bag play input_bag --rate 2.0 --clock 200

# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§è¨˜éŒ²ã€‚input_bagã®durationã®åŠåˆ†ã«ãªã‚‹ã€‚
ros2 bag record -a
```

use-sim-timeãŒåæ˜ ã•ã‚Œã‚‹ã¨ã€rateã‚’å¤‰æ›´ã—ã¦ã‚‚ã“ã†ã„ã£ãŸå•é¡ŒãŒèµ·ã“ã‚‰ãªããªã‚Šã¾ã™ã€‚

ROS1ã ã¨use-sim-timeãŒtrueãªã‚‰sim-timeã§è¨˜éŒ²ã•ã‚Œã¦ã„ãŸã®ã§ã€ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ROS1ã®ã¨ãã¨åŒç­‰ã®å‹•ä½œã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## clockãŒæ¥ã¦ã‹ã‚‰è¨˜éŒ²ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ

2024.06 è¿½è¨˜

0.15.3-1ã§--use-sim-timeã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå…¥ã£ãŸã¨ãã¯ã€clockãŒæ¥ã‚‹å‰ã«topicãŒã§ã‚‹ã¨0ç§’ã™ãªã‚ã¡	1970-01-01T00:00:00ã«ãªã‚Šã€clockãŒããŸç¬é–“ã«rosæ™‚é–“ãŒé£›ã‚“ã§ã—ã¾ã†ä»•æ§˜ã ã£ãŸã€‚
ã“ã®ãŸã‚recordé–‹å§‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’playerã®ã‚ã¨ã«ã™ã‚‹ãªã©ã€èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€launchã‹ã‚‰å‘¼ã³å‡ºã™å ´åˆãªã©ã«ã€èµ·å‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆã‚ã›ã‚‹ã®ãŒé›£ã—ã„å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

ç¾åœ¨ã¯ã€ä»¥ä¸‹ã®ãƒ˜ãƒ«ãƒ—ã®æ–‡è¨€ã®ã‚ˆã†ã«ã€clockãŒæ¥ã¦ã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é–‹å§‹ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
ã“ã‚Œã§ã€ROS 1ã®ã¨ãã¨åŒæ§˜ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```shell
â¯ ros2 bag record -h
usage: ros2 bag record [-h] [-a] [-e REGEX] [-x EXCLUDE]
...
   --use-sim-time        Use simulation time for message timestamps by
                        subscribing to the /clock topic. Until first /clock
                        message is received, no messages will be written to
                        bag.
```

## å…¬é–‹ã•ã‚Œã¦ã„ã‚‹bagã‚’ä½¿ã£ã¦è©¦ã—ã¦ã¿ã‚‹

[ã“ã“ã«ç½®ã„ã¦ã‚ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿](https://tier4.github.io/driving_log_replayer/quick_start/setup/)
ã‚’ä½¿ã£ã¦å®Ÿéš›ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ç¢ºã‹ã‚ã¦ã¿ã‚‹ã€‚

### å†ç”Ÿã™ã‚‹bagã®å†…å®¹

å†ç”Ÿã™ã‚‹bagã®å†…å®¹ã‚’ç¤ºã™ã€‚
autowareã®ç‹¬è‡ªå®šç¾©å‹ã‚’å«ã‚€bagã§ã€2022å¹´4æœˆ5æ—¥ã«å–ã‚‰ã‚ŒãŸ68.972sã®bag

```shell
â¯ ros2 bag info input_bag/

Files:             input_bag_0.db3
Bag size:          2.6 GiB
Storage id:        sqlite3
Duration:          68.972s
Start:             Apr  5 2022 15:07:31.594 (1649138851.594)
End:               Apr  5 2022 15:08:40.566 (1649138920.566)
Messages:          21590
Topic information: Topic: /localization/kinematic_state | Type: nav_msgs/msg/Odometry | Count: 3440 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/fix_velocity | Type: geometry_msgs/msg/TwistWithCovarianceStamped | Count: 345 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/nav_sat_fix | Type: sensor_msgs/msg/NavSatFix | Count: 343 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/navpvt | Type: ublox_msgs/msg/NavPVT | Count: 344 | Serialization Format: cdr
                   Topic: /sensing/imu/tamagawa/imu_raw | Type: sensor_msgs/msg/Imu | Count: 1936 | Serialization Format: cdr
                   Topic: /sensing/lidar/concatenated/pointcloud | Type: sensor_msgs/msg/PointCloud2 | Count: 685 | Serialization Format: cdr
                   Topic: /sensing/lidar/left/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 688 | Serialization Format: cdr
                   Topic: /sensing/lidar/right/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 687 | Serialization Format: cdr
                   Topic: /sensing/lidar/top/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 685 | Serialization Format: cdr
                   Topic: /tf | Type: tf2_msgs/msg/TFMessage | Count: 4484 | Serialization Format: cdr
                   Topic: /tf_static | Type: tf2_msgs/msg/TFMessage | Count: 2 | Serialization Format: cdr
                   Topic: /vehicle/status/control_mode | Type: autoware_auto_vehicle_msgs/msg/ControlModeReport | Count: 1985 | Serialization Format: cdr
                   Topic: /vehicle/status/steering_status | Type: autoware_auto_vehicle_msgs/msg/SteeringReport | Count: 1990 | Serialization Format: cdr
                   Topic: /vehicle/status/turn_indicators_status | Type: autoware_auto_vehicle_msgs/msg/TurnIndicatorsReport | Count: 1988 | Serialization Format: cdr
                   Topic: /vehicle/status/velocity_status | Type: autoware_auto_vehicle_msgs/msg/VelocityReport | Count: 1988 | Serialization Format: cdr
```

### sim_timeã‚’ã¤ã‘ãšã«å€é€Ÿå†ç”Ÿã—ã¦è¨˜éŒ²ã™ã‚‹

#### å†ç”Ÿå´ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«

```shell
# bagã«autowareã«ç‹¬è‡ªå®šç¾©å‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§autowareã®workspaceã‚’äº‹å‰ã«sourceã—ã¦ãŠã
# cd autoware
# source install/setup.bash
~/sample_dataset
â¯ ros2 bag play input_bag --rate 2.0 --clock
```

#### è¨˜éŒ²å´

```shell
# bagã«autowareã«ç‹¬è‡ªå®šç¾©å‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§autowareã®workspaceã‚’äº‹å‰ã«sourceã—ã¦ãŠã
# cd autoware
# source install/setup.bash
ros2 bag record -a
```

#### è¨˜éŒ²ã•ã‚ŒãŸbagã‚’infoã—ãŸçµæœ

ãƒ¬ã‚³ãƒ¼ãƒ‰ã—ãŸbagã®çµæœã€‚æ‰‹å‹•ã§ã‚„ã£ã¦ã„ã‚‹ã®ã§å°‘ã—å–ã‚Šã“ã¼ã—ãŒã‚ã‚Šã¾ã™ãŒã€topicæ•°ã¯å¤§ä½“åŒã˜ã§durationãŒåŠåˆ†ã®bagãŒã§ãã¾ã—ãŸã€‚

```shell
â¯ ros2 bag info rosbag2_2022_11_30-04_03_30/

Files:             rosbag2_2022_11_30-04_03_30_0.db3
Bag size:          2.5 GiB
Storage id:        sqlite3
Duration:          32.730s
Start:             Nov 30 2022 04:03:30.663 (1669748610.663)
End:               Nov 30 2022 04:04:03.393 (1669748643.393)
Messages:          21856
Topic information: Topic: /clock | Type: rosgraph_msgs/msg/Clock | Count: 1310 | Serialization Format: cdr
                   Topic: /localization/kinematic_state | Type: nav_msgs/msg/Odometry | Count: 3275 | Serialization Format: cdr
                   Topic: /rosout | Type: rcl_interfaces/msg/Log | Count: 10 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/fix_velocity | Type: geometry_msgs/msg/TwistWithCovarianceStamped | Count: 327 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/nav_sat_fix | Type: sensor_msgs/msg/NavSatFix | Count: 327 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/navpvt | Type: ublox_msgs/msg/NavPVT | Count: 327 | Serialization Format: cdr
                   Topic: /sensing/imu/tamagawa/imu_raw | Type: sensor_msgs/msg/Imu | Count: 1845 | Serialization Format: cdr
                   Topic: /sensing/lidar/concatenated/pointcloud | Type: sensor_msgs/msg/PointCloud2 | Count: 653 | Serialization Format: cdr
                   Topic: /sensing/lidar/left/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 654 | Serialization Format: cdr
                   Topic: /sensing/lidar/right/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 655 | Serialization Format: cdr
                   Topic: /sensing/lidar/top/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 654 | Serialization Format: cdr
                   Topic: /tf | Type: tf2_msgs/msg/TFMessage | Count: 4259 | Serialization Format: cdr
                   Topic: /tf_static | Type: tf2_msgs/msg/TFMessage | Count: 2 | Serialization Format: cdr
                   Topic: /vehicle/status/control_mode | Type: autoware_auto_vehicle_msgs/msg/ControlModeReport | Count: 1889 | Serialization Format: cdr
                   Topic: /vehicle/status/steering_status | Type: autoware_auto_vehicle_msgs/msg/SteeringReport | Count: 1889 | Serialization Format: cdr
                   Topic: /vehicle/status/turn_indicators_status | Type: autoware_auto_vehicle_msgs/msg/TurnIndicatorsReport | Count: 1890 | Serialization Format: cdr
                   Topic: /vehicle/status/velocity_status | Type: autoware_auto_vehicle_msgs/msg/VelocityReport | Count: 1890 | Serialization Format: cdr
```

### sim_timeã‚’ã¤ã‘ã¦å€é€Ÿå†ç”Ÿã—ã¦è¨˜éŒ²ã™ã‚‹

#### å†ç”Ÿå´ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«

```shell
# bagã«autowareã«ç‹¬è‡ªå®šç¾©å‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§autowareã®workspaceã‚’äº‹å‰ã«sourceã—ã¦ãŠã
# cd autoware
# source install/setup.bash
~/sample_dataset
â¯ ros2 bag play input_bag --rate 2.0 --clock
```

#### è¨˜éŒ²å´

```shell
# bagã«autowareã«ç‹¬è‡ªå®šç¾©å‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§autowareã®workspaceã‚’äº‹å‰ã«sourceã—ã¦ãŠã
# cd autoware
# source install/setup.bash
ros2 bag record -a --use-sim-time
```

#### è¨˜éŒ²ã•ã‚ŒãŸbagã‚’infoã—ãŸçµæœ

ãƒ¬ã‚³ãƒ¼ãƒ‰ã—ãŸbagã®çµæœã€‚
bag playã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰recordã—ã¦ã„ã‚‹ã®ã§ã€æœ€åˆ2ç§’ãã‚‰ã„ã¯å–ã‚Šã“ã¼ã—ã¦ã„ã¾ã™ãŒã€å…¥åŠ›ã¨åŒã˜æ™‚åˆ»ã«ãªã£ã¦ã„ã¾ã™ã€‚

ãã¡ã‚“ã¨sim-timeãŒåæ˜ ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

```shell
â¯ ros2 bag info rosbag2_2022_11_30-04_25_00/

Files:             rosbag2_2022_11_30-04_25_00_0.db3
Bag size:          2.5 GiB
Storage id:        sqlite3
Duration:          66.700s
Start:             Apr  5 2022 15:07:33.856 (1649138853.856)
End:               Apr  5 2022 15:08:40.557 (1649138920.557)
Messages:          22266
Topic information: Topic: /clock | Type: rosgraph_msgs/msg/Clock | Count: 1334 | Serialization Format: cdr
                   Topic: /localization/kinematic_state | Type: nav_msgs/msg/Odometry | Count: 3336 | Serialization Format: cdr
                   Topic: /rosout | Type: rcl_interfaces/msg/Log | Count: 10 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/fix_velocity | Type: geometry_msgs/msg/TwistWithCovarianceStamped | Count: 333 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/nav_sat_fix | Type: sensor_msgs/msg/NavSatFix | Count: 333 | Serialization Format: cdr
                   Topic: /sensing/gnss/ublox/navpvt | Type: ublox_msgs/msg/NavPVT | Count: 334 | Serialization Format: cdr
                   Topic: /sensing/imu/tamagawa/imu_raw | Type: sensor_msgs/msg/Imu | Count: 1880 | Serialization Format: cdr
                   Topic: /sensing/lidar/concatenated/pointcloud | Type: sensor_msgs/msg/PointCloud2 | Count: 666 | Serialization Format: cdr
                   Topic: /sensing/lidar/left/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 666 | Serialization Format: cdr
                   Topic: /sensing/lidar/right/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 667 | Serialization Format: cdr
                   Topic: /sensing/lidar/top/velodyne_packets | Type: velodyne_msgs/msg/VelodyneScan | Count: 666 | Serialization Format: cdr
                   Topic: /tf | Type: tf2_msgs/msg/TFMessage | Count: 4339 | Serialization Format: cdr
                   Topic: /tf_static | Type: tf2_msgs/msg/TFMessage | Count: 2 | Serialization Format: cdr
                   Topic: /vehicle/status/control_mode | Type: autoware_auto_vehicle_msgs/msg/ControlModeReport | Count: 1925 | Serialization Format: cdr
                   Topic: /vehicle/status/steering_status | Type: autoware_auto_vehicle_msgs/msg/SteeringReport | Count: 1925 | Serialization Format: cdr
                   Topic: /vehicle/status/turn_indicators_status | Type: autoware_auto_vehicle_msgs/msg/TurnIndicatorsReport | Count: 1925 | Serialization Format: cdr
                   Topic: /vehicle/status/velocity_status | Type: autoware_auto_vehicle_msgs/msg/VelocityReport | Count: 1925 | Serialization Format: cdr
```

## ãŠã¾ã‘

ros2 bag reindexã®ã‚³ãƒãƒ³ãƒ‰ã®ä½¿ã„æ–¹ãŒå°‘ã—å¤‰ã‚ã£ã¦ã„ã¾ã—ãŸã€‚`-s`ã®ã‚ã¨ã«storageã‚’æ›¸ãã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```shell
â¯ ros2 bag reindex -h
usage: ros2 bag reindex [-h] [-s {my_test_plugin,my_read_only_test_plugin,sqlite3,mcap}] bag_path

Reconstruct metadata file for a bag

positional arguments:
  bag_path              Bag to open

options:
  -h, --help            show this help message and exit
  -s {my_test_plugin,my_read_only_test_plugin,sqlite3,mcap}, --storage {my_test_plugin,my_read_only_test_plugin,sqlite3,mcap}
                        Storage implementation of bag. By default attempts to detect automatically - use this argument to override.
```

ä»–ã«ã‚‚ä»Šå›ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä½¿ã„æ–¹ãŒå¤‰ã‚ã£ãŸã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãƒ˜ãƒ«ãƒ—ã¿ã¦ã¾ã—ã‚‡ã†
